<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>KUDHIN SPLIT — Modern</title>
<link rel="icon" href="data:;base64,iVBORw0KGgo=">
<style>
  :root{
    --blue: #1e88e5;
    --blue-100: #eaf5ff;
    --blue-200: #cfefff;
    --blue-300: #b6e3ff;
    --bg: #f6fbff;
    --card: #ffffff;
    --muted: #6b7a8f;
    --danger: #ef5350;
    --ok: #43a047;
    --glass: rgba(255,255,255,0.85);
    --radius: 14px;
    --shadow: 0 8px 22px rgba(18,35,68,0.06);
    --pill-h: 34px;
    --gap: 10px;
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:#122033;-webkit-font-smoothing:antialiased}
  /* app shell */
  .app-shell{max-width:420px;margin:8px auto;height:calc(100dvh - 16px);display:flex;flex-direction:column;box-sizing:border-box;padding:8px}
  header.app-header{
    height:60px;display:flex;align-items:center;justify-content:space-between;gap:8px;
    background:linear-gradient(180deg,var(--blue),#1976d2);color:#fff;padding:10px;border-radius:12px;
    box-shadow:var(--shadow);position:relative;z-index:20;
  }
  .profile{
    display:flex;align-items:center;gap:10px;
  }
  .avatar{
    width:42px;height:42px;border-radius:10px;display:flex;align-items:center;justify-content:center;
    background:rgba(255,255,255,0.12);font-weight:700;font-size:14px;
  }
  .profile .meta{line-height:1}
  .profile .meta .name{font-weight:700;font-size:14px}
  .profile .meta .mobile{font-size:12px;opacity:.9}
  button.icon-btn{background:transparent;border:none;color:#fff;font-size:20px;padding:6px;border-radius:8px;cursor:pointer}
  button.icon-btn:active{transform:scale(.98)}
  /* main area */
  main.app-main{flex:1;overflow:auto;padding:12px 0;}
  .card{background:var(--card);border-radius:12px;padding:12px;margin-bottom:12px;box-shadow:0 6px 18px rgba(20,40,80,0.04)}
  .row{display:flex;gap:8px;align-items:center}
  .row .col{flex:1}
  input,select,button{font-family:inherit}
  input[type=text],input[type=number],select{
    width:100%;padding:10px;border-radius:10px;border:1px solid #e6f0fb;background:transparent;box-sizing:border-box;font-size:14px
  }
  .small{font-size:12px;color:var(--muted)}
  .btn{height:var(--pill-h);border-radius:10px;padding:0 12px;border:none;cursor:pointer;font-weight:600}
  .btn-primary{background:var(--blue);color:#fff}
  .btn-ghost{background:transparent;border:1px solid rgba(18,40,70,0.06);color:#122033}
  .btn-danger{background:var(--danger);color:#fff}
  .btn-ok{background:var(--ok);color:#fff}
  /* GST pill */
  .pill{
    display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:var(--blue-200);height:var(--pill-h);
    border:1px solid rgba(18,40,70,0.04);cursor:pointer;user-select:none;
  }
  .pill .dot{width:14px;height:14px;border-radius:50%;background:#fff;display:inline-block;box-shadow:0 1px 2px rgba(0,0,0,0.08)}
  .pill.active{background:linear-gradient(90deg,var(--ok),#2e8b57);color:#fff}
  .pill.active .dot{background:#fff}
  /* tables */
  .table-wrap{overflow:hidden;border-radius:10px;border:1px solid #eef7ff}
  table{width:100%;border-collapse:collapse;font-size:14px}
  th,td{padding:10px;text-align:left}
  thead th{background:transparent;color:var(--muted);font-weight:700;border-bottom:1px solid #f3fbff}
  tbody tr:nth-child(odd){background:#fbfdff}
  .muted{color:var(--muted)}
  .tag{display:inline-block;padding:6px 8px;border-radius:999px;background:#f1fbff;border:1px solid #e2f2ff;font-size:12px}
  /* person & shared lists */
  .list-row{display:flex;align-items:center;gap:8px;padding:8px;border-radius:10px;border:1px solid #f0f7ff;margin-bottom:8px}
  .list-row .title{font-weight:700}
  .list-row .meta{font-size:12px;color:var(--muted)}
  .list-actions{margin-left:auto;display:flex;gap:8px}
  .remove-sm{background:transparent;border:1px solid rgba(0,0,0,0.06);padding:6px;border-radius:8px;color:var(--danger);font-weight:700;cursor:pointer}
  /* nav bottom */
  nav.app-nav{display:flex;gap:8px;justify-content:space-between;background:linear-gradient(180deg,var(--blue-200),#d6eefc);padding:8px;border-radius:12px;position:sticky;bottom:0;margin-top:8px}
  nav.app-nav button{flex:1;border-radius:10px;padding:10px;border:none;background:transparent;color:#034a7a;font-weight:700}
  nav.app-nav button.active{background:#fff;color:var(--blue);box-shadow:0 6px 16px rgba(30,120,210,0.12)}
  /* modal */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,8,23,0.45);z-index:80;padding:18px}
  .modal.open{display:flex}
  .panel{width:min(420px,100%);background:var(--card);border-radius:14px;padding:14px;box-shadow:0 18px 40px rgba(6,16,35,0.2)}
  .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
  /* owings cards */
  .owings-grid{display:grid;grid-template-columns:1fr;gap:10px}
  .owing-card{display:flex;flex-direction:column;padding:12px;border-radius:12px;border:1px solid #eef7ff;background:linear-gradient(180deg,#fff,#fbfdff)}
  .owing-top{display:flex;align-items:center;gap:8px}
  .status{padding:6px 8px;border-radius:999px;font-weight:700;font-size:12px}
  .status.UNPAID{background:#fff0f0;color:#b00000;border:1px solid rgba(239,83,80,0.1)}
  .status.PAID{background:#fff8e6;color:#a97a00;border:1px solid rgba(255,193,7,0.08)}
  .status.RECEIVED{background:#eaf9ef;color:#1b8a57;border:1px solid rgba(76,175,80,0.08)}
  .owing-actions{display:flex;gap:8px;margin-top:10px}
  /* responsive tweaks */
  @media (min-width:520px){
    .app-shell{box-shadow:0 12px 36px rgba(6,16,35,0.06);border-radius:18px;padding:16px}
  }
</style>
</head>
<body>

<div class="app-shell" id="appShell">

  <!-- LOGIN SCREEN -->
  <div id="loginScreen" class="">
    <div class="card">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <div>
          <div style="font-weight:800;font-size:18px">KUDHIN SPLIT</div>
          <div class="small" style="margin-top:4px">Simple, modern bill splitter</div>
        </div>
        <div class="tag small">OFFLINE</div>
      </div>
    </div>

    <div class="card">
      <div style="font-weight:700;margin-bottom:8px">Login</div>
      <label class="small">Select user</label>
      <select id="loginSelect" style="margin-bottom:8px"></select>
      <label class="small">Mobile (as password)</label>
      <input id="loginMobile" type="text" placeholder="MOBILE NUMBER" />
      <div style="display:flex;gap:8px;margin-top:10px">
        <button class="btn btn-primary" style="flex:1" onclick="login()">LOGIN</button>
        <button class="btn btn-ghost" onclick="prefillDemo()">DEMO</button>
      </div>
      <div class="small" style="margin-top:8px;color:var(--muted)">Users are pre-defined. Choose user and enter correct mobile to proceed.</div>
    </div>
  </div>

  <!-- APP SHELL -->
  <div id="app" style="display:none;flex-direction:column;height:100%">

    <!-- header -->
    <header class="app-header">
      <div class="profile">
        <div class="avatar" id="avatarInitial">K</div>
        <div class="meta">
          <div id="profileName" class="name">-</div>
          <div id="profileMobile" class="mobile small">-</div>
        </div>
      </div>

      <div style="display:flex;gap:8px;align-items:center">
        <button id="hamburger" class="icon-btn" title="Settings">☰</button>
      </div>
    </header>

    <main class="app-main">
      <!-- SPLITTER -->
      <section id="tab-splitter" class="card">
        <div style="display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:8px">
          <div style="display:flex;gap:8px;align-items:center">
            <button class="btn btn-primary" onclick="startAddPerson()">+ Add Person</button>
            <button class="btn btn-primary" onclick="openSharedPopup()">+ Shared Item</button>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <div id="gstToggle" class="pill" onclick="toggleGST()" title="Toggle GST 8%">
              <div class="dot"></div>
              <div style="font-weight:700">GST 8%</div>
            </div>
            <button class="btn btn-ok" onclick="openPreview()">Preview</button>
          </div>
        </div>

        <div style="display:flex;gap:8px;margin-bottom:10px;flex-wrap:wrap">
          <div style="flex:1;min-width:150px">
            <label class="small">Bill date</label>
            <input id="billDate" type="date" />
          </div>
          <div style="flex:1;min-width:150px">
            <label class="small">Payer</label>
            <select id="payerSelect"></select>
          </div>
        </div>

        <div style="margin-bottom:10px">
          <label class="small">Vendor</label>
          <select id="vendorSelect"></select>
        </div>

        <div style="margin-bottom:10px">
          <label class="small">Manual Service (Amount) — will be split <strong>equally</strong></label>
          <input id="manualService" type="number" placeholder="0.00" />
        </div>

        <div style="margin-top:6px">
          <div style="font-weight:700;margin-bottom:8px">Persons</div>
          <div id="personsList"></div>
          <div class="small muted" id="noPersonsHint" style="display:block">No persons yet — add a person to begin.</div>
        </div>

        <div style="margin-top:12px">
          <div style="font-weight:700;margin-bottom:8px">Shared Items</div>
          <div id="sharedList"></div>
          <div class="small muted" id="noSharedHint" style="display:block">No shared items — add shared items here.</div>
        </div>
      </section>

      <!-- OWINGS -->
      <section id="tab-owings" class="card" style="display:none">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
          <div style="font-weight:700">Owings & Settlements</div>
          <div class="small muted">Track who owes whom</div>
        </div>

        <div id="owingsArea" class="owings-grid"></div>
      </section>

      <!-- SETTINGS -->
      <section id="tab-settings" class="card" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div style="font-weight:800">Users</div>
            <div class="small muted">Fixed users for login & payer selection</div>
          </div>
          <div style="text-align:right">
            <div class="small muted">Local storage</div>
          </div>
        </div>

        <div style="margin-top:8px" id="userListArea"></div>

        <div style="margin-top:12px">
          <div style="font-weight:700">Add Vendor</div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <input id="newVendor" type="text" placeholder="Vendor name" />
            <button class="btn btn-primary" onclick="addVendor()">Add</button>
          </div>
          <div id="vendorList" style="margin-top:8px;display:flex;flex-wrap:wrap;gap:8px"></div>
        </div>

        <div style="margin-top:14px;display:flex;gap:8px">
          <button class="btn btn-ghost" onclick="exportData()">Export JSON</button>
          <button class="btn btn-ghost" onclick="clearAll()">Clear All</button>
        </div>
      </section>
    </main>

    <nav class="app-nav">
      <button id="nav-splitter" class="active" onclick="switchTab('splitter')">Splitter</button>
      <button id="nav-owings" onclick="switchTab('owings')">Owings</button>
      <button id="nav-settings" onclick="switchTab('settings')">Settings</button>
    </nav>

  </div>
</div>

<!-- Modal -->
<div id="modal" class="modal" aria-modal="true" role="dialog">
  <div class="panel">
    <h3 id="modal-title" style="margin:0 0 8px 0;font-size:16px">Title</h3>
    <div id="modal-body"></div>
    <div class="actions">
      <button id="modal-cancel" class="btn btn-ghost" onclick="closeModal()">CANCEL</button>
      <button id="modal-primary" class="btn btn-primary">NEXT</button>
    </div>
  </div>
</div>

<!-- jsPDF (for PDF export) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
/* ===== storage keys & default users ===== */
const LS_USERS = "KUDHIN_users", LS_VENDORS="KUDHIN_vendors", LS_OWINGS="KUDHIN_owings", LS_BILLS="KUDHIN_bills";
let users = JSON.parse(localStorage.getItem(LS_USERS)) || [
  {name:"MIUSHAAN", mobile:"9996912"},
  {name:"RAYA", mobile:"9996912"},
  {name:"ASLAN", mobile:"9996912"},
  {name:"REESHA", mobile:"9996912"},
  {name:"ZIPPE", mobile:"9996912"},
  {name:"AFU", mobile:"9996912"},
  {name:"APPAL", mobile:"9996912"},
  {name:"IRUFAAN", mobile:"9996912"},
  {name:"ULY", mobile:"9996912"}
];
let vendors = JSON.parse(localStorage.getItem(LS_VENDORS)) || [];
let owings = JSON.parse(localStorage.getItem(LS_OWINGS)) || [];
let bills = JSON.parse(localStorage.getItem(LS_BILLS)) || [];
let billCounter = (bills[bills.length-1]?.billID || 0) + 1;

/* runtime state */
let persons = [];        // [{name, items:[{item,amount}]}]
let sharedItems = [];    // [{item,amount}]
let gstEnabled = false;

/* helpers */
const el = sel => document.querySelector(sel);
const qp = (sel,root=document) => root.querySelector(sel);
const toUpper = v => (v||"").toString().toUpperCase();
const saveLS = (k,v) => localStorage.setItem(k, JSON.stringify(v));
const showModal = ()=>el('#modal').classList.add('open');
const hideModal = ()=>el('#modal').classList.remove('open');
const format2 = n => (Math.round((Number(n) + Number.EPSILON)*100)/100).toFixed(2);

/* init UI population */
(function init(){
  updateLoginSelect(); refreshVendorSelect(); refreshVendorList(); updatePayerSelect(); renderUsers(); renderOwings();
  // hamburger opens settings
  el('#hamburger').addEventListener('click', ()=> switchTab('settings'));
  // wire nav buttons initial
  document.querySelectorAll('nav.app-nav button').forEach(b=> b.addEventListener('click', ()=> {
    document.querySelectorAll('nav.app-nav button').forEach(x=>x.classList.remove('active')); b.classList.add('active');
  }));
})();

/* ===== LOGIN ===== */
function updateLoginSelect(){
  el('#loginSelect').innerHTML = `<option value="">-- SELECT USER --</option>` + users.map((u,i)=>`<option value="${i}">${u.name}</option>`).join('');
}
function login(){
  const idx = parseInt(el('#loginSelect').value,10);
  const mobile = toUpper(el('#loginMobile').value).trim();
  if(Number.isInteger(idx) && users[idx] && toUpper(users[idx].mobile) === mobile){
    const u = users[idx];
    el('#profileName').textContent = u.name;
    el('#profileMobile').textContent = u.mobile;
    el('#avatarInitial').textContent = u.name.slice(0,1) || 'K';
    el('#loginScreen').style.display = 'none';
    el('#app').style.display = 'flex';
    // set payer select to logged in by default (if exists)
    setTimeout(()=> { updatePayerSelect(); el('#payerSelect').value = u.name; }, 50);
  } else {
    alert('INVALID CREDENTIALS — pick a user and type the mobile exactly.');
  }
}
function prefillDemo(){
  // auto-login first user for demo (no validation)
  const u = users[0];
  el('#profileName').textContent = u.name;
  el('#profileMobile').textContent = u.mobile;
  el('#avatarInitial').textContent = u.name.slice(0,1) || 'K';
  el('#loginScreen').style.display = 'none';
  el('#app').style.display = 'flex';
  updatePayerSelect(); el('#payerSelect').value = u.name;
}

/* ===== tabs ===== */
function switchTab(tab){
  ['splitter','owings','settings'].forEach(t=> el(`#tab-${t}`).style.display = 'none');
  el(`#tab-${tab}`).style.display = 'block';
  document.querySelectorAll('nav.app-nav button').forEach(b=>b.classList.remove('active'));
  el(`#nav-${tab}`).classList.add('active');
}

/* ===== settings & vendors ===== */
function renderUsers(){
  el('#userListArea').innerHTML = users.map(u=>`<div style="padding:8px;border-radius:8px;border:1px solid #f0f8ff;margin-bottom:6px">${u.name} <span class="small muted">(${u.mobile})</span></div>`).join('');
}
function addVendor(){
  const v = toUpper(el('#newVendor').value).trim();
  if(!v) return alert('VENDOR REQUIRED');
  if(vendors.includes(v)) return alert('VENDOR EXISTS');
  vendors.push(v); saveLS(LS_VENDORS,vendors); el('#newVendor').value=''; refreshVendorSelect(); refreshVendorList();
}
function refreshVendorSelect(){ el('#vendorSelect').innerHTML = `<option value="">-- SELECT VENDOR --</option>` + vendors.map(v=>`<option>${v}</option>`).join(''); }
function refreshVendorList(){ el('#vendorList').innerHTML = vendors.map(v=>`<div class="tag">${v}</div>`).join(''); }

/* ===== payer select ===== */
function updatePayerSelect(){ el('#payerSelect').innerHTML = `<option value="">-- SELECT --</option>` + users.map(u=>`<option>${u.name}</option>`).join(''); }

/* ===== GST toggle (visual highlight) ===== */
function toggleGST(){
  gstEnabled = !gstEnabled;
  const btn = el('#gstToggle');
  btn.classList.toggle('active', gstEnabled);
}

/* ===== render persons & shared lists ===== */
function renderPersons(){
  const wrap = el('#personsList'); wrap.innerHTML = '';
  if(persons.length === 0){ el('#noPersonsHint').style.display = 'block'; return; } else el('#noPersonsHint').style.display = 'none';
  persons.forEach((p,pi)=>{
    const container = document.createElement('div'); container.className='list-row';
    const left = document.createElement('div'); left.style.display='flex';left.style.flexDirection='column';
    const title = document.createElement('div'); title.className='title'; title.textContent = p.name;
    const meta = document.createElement('div'); meta.className='meta small'; meta.textContent = `${p.items.length} items • ${format2(p.items.reduce((s,i)=>s + Number(i.amount||0),0))}`;
    left.appendChild(title); left.appendChild(meta);
    const actions = document.createElement('div'); actions.className='list-actions';
    const addItemBtn = document.createElement('button'); addItemBtn.className='btn btn-ghost'; addItemBtn.textContent = 'Add Item'; addItemBtn.onclick = ()=> startAddItemFor(p.name);
    const remBtn = document.createElement('button'); remBtn.className='remove-sm'; remBtn.textContent='REMOVE'; remBtn.onclick = ()=> { if(confirm('Remove this person?')) { persons.splice(pi,1); renderPersons(); } };
    actions.appendChild(addItemBtn); actions.appendChild(remBtn);
    container.appendChild(left); container.appendChild(actions);

    // items preview
    const itemBox = document.createElement('div'); itemBox.style.marginTop='8px';
    if(p.items.length === 0){ const no = document.createElement('div'); no.className='small muted'; no.textContent='No items'; itemBox.appendChild(no); }
    else p.items.forEach((it,ii)=>{
      const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.padding='6px 8px'; row.style.borderRadius='8px'; row.style.marginTop='6px'; row.style.background='#fbfdff';
      const left = document.createElement('div'); left.innerHTML = `<div style="font-weight:700">${it.item}</div><div class="small muted">${format2(it.amount)}</div>`;
      const rm = document.createElement('button'); rm.className='remove-sm'; rm.textContent='x'; rm.onclick = ()=> { p.items.splice(ii,1); renderPersons(); };
      row.appendChild(left); row.appendChild(rm); itemBox.appendChild(row);
    });

    wrap.appendChild(container); wrap.appendChild(itemBox);
  });
}

function renderShared(){
  const wrap = el('#sharedList'); wrap.innerHTML = '';
  if(sharedItems.length === 0){ el('#noSharedHint').style.display = 'block'; return; } else el('#noSharedHint').style.display = 'none';
  sharedItems.forEach((s,si)=>{
    const row = document.createElement('div'); row.className='list-row';
    const left = document.createElement('div'); left.style.display='flex';left.style.flexDirection='column';
    const title = document.createElement('div'); title.className='title'; title.textContent = s.item;
    const meta = document.createElement('div'); meta.className='meta small'; meta.textContent = format2(s.amount);
    left.appendChild(title); left.appendChild(meta);
    const rem = document.createElement('button'); rem.className='remove-sm'; rem.textContent='REMOVE'; rem.onclick = ()=> { sharedItems.splice(si,1); renderShared(); };
    row.appendChild(left); row.appendChild(rem);
    wrap.appendChild(row);
  });
}

/* ===== add person + multi-step add item ===== */
let stepPerson = null;
function startAddPerson(){ stepPerson = null; showSelectPerson(); }

function openModal(title, bodyHTML, primaryText='NEXT', primaryHandler=null){
  el('#modal-title').textContent = title;
  el('#modal-body').innerHTML = bodyHTML;
  const pbtn = el('#modal-primary'); pbtn.textContent = primaryText;
  pbtn.onclick = primaryHandler || (()=>{});
  showModal();
}
function closeModal(){ hideModal(); }

function showSelectPerson(){
  const options = users.map(u=>`<option value="${u.name}">${u.name}</option>`).join('');
  openModal('SELECT PERSON', `<select id="selPerson" style="width:100%"><option value="">-- SELECT USER --</option>${options}</select>`, 'NEXT', ()=>{
    const v = toUpper(qp('#selPerson').value).trim(); if(!v) return alert('SELECT A USER'); stepPerson = v; showItemName();
  });
}

function showItemName(){
  openModal(`ADD ITEM FOR ${stepPerson}`, `<input id="itemName" type="text" placeholder="ITEM NAME" />`, 'NEXT', ()=>{
    const v = toUpper(qp('#itemName').value).trim(); if(!v) return alert('ENTER ITEM NAME'); stepItem = v; showItemPrice();
  });
}

let stepItem = null;
function showItemPrice(){
  openModal(`ENTER PRICE FOR ${stepItem}`, `
    <input id="itemPrice" type="number" placeholder="AMOUNT" />
    <div style="display:flex;gap:8px;margin-top:8px">
      <button id="btnMore" class="btn btn-ghost" style="flex:1">Add more items</button>
      <button id="btnNextPerson" class="btn btn-primary" style="flex:1">Add next person</button>
    </div>
  `, 'SAVE', ()=>{
    doAddItem(false);
  });
  qp('#btnMore').onclick = ()=> doAddItem(false);
  qp('#btnNextPerson').onclick = ()=> doAddItem(true);
}

function doAddItem(nextPerson){
  const price = parseFloat(qp('#itemPrice').value) || 0;
  if(!(price>0)) return alert('ENTER VALID AMOUNT');
  let p = persons.find(x=>x.name===stepPerson);
  if(!p){ p = {name: stepPerson, items:[]}; persons.push(p); }
  p.items.push({item: stepItem, amount: price});
  renderPersons();
  if(nextPerson){ stepPerson = null; stepItem = null; showSelectPerson(); }
  else { stepItem = null; showItemName(); }
}

/* start add item for existing person */
function startAddItemFor(name){
  stepPerson = name; showItemName();
}

/* ===== shared items popup ===== */
function openSharedPopup(){
  openModal('ADD SHARED ITEM', `<input id="sharedName" type="text" placeholder="ITEM NAME" /><input id="sharedAmt" type="number" placeholder="AMOUNT" style="margin-top:8px" />`, 'ADD', ()=>{
    const n = toUpper(qp('#sharedName').value).trim(); const a = parseFloat(qp('#sharedAmt').value)||0;
    if(!n) return alert('ENTER ITEM NAME'); if(!(a>0)) return alert('ENTER VALID AMOUNT'); sharedItems.push({item:n, amount:a}); renderShared(); closeModal();
  });
}

/* ===== totals logic (manual service split equally) ===== */
function computeTotalsDetailed(){
  const peopleCount = persons.length || 1;
  const totalShared = sharedItems.reduce((s,it)=>s + Number(it.amount||0), 0);
  const sharedPerPerson = peopleCount ? (totalShared / peopleCount) : 0;
  const manualServiceTotal = parseFloat(el('#manualService').value) || 0;
  const manualPerPerson = peopleCount ? (manualServiceTotal / peopleCount) : 0;

  const perPersonBase = persons.map(p=>{
    const own = p.items.reduce((s,it)=>s + Number(it.amount||0), 0);
    return { name:p.name, own, sharedShare: sharedPerPerson, manualShare: manualPerPerson, baseBeforeTax: own + sharedPerPerson + manualPerPerson };
  });

  const lines = perPersonBase.map(pp=>{
    const gstAmt = gstEnabled ? (pp.baseBeforeTax * 0.08) : 0;
    const total = pp.baseBeforeTax + gstAmt;
    return {
      name: pp.name,
      itemsTotal: format2(pp.own),
      sharedShare: format2(pp.sharedShare),
      manualShare: format2(pp.manualShare),
      gstShare: format2(gstAmt),
      total: format2(total)
    };
  });

  const grandTotal = format2(lines.reduce((s,l)=> s + Number(l.total), 0));
  return { lines, grandTotal, sharedPerPerson: format2(sharedPerPerson), manualPerPerson: format2(manualPerPerson) };
}

/* ===== preview popup with breakdown ===== */
function openPreview(){
  if(persons.length === 0) return alert('ADD AT LEAST ONE PERSON');
  const vendor = el('#vendorSelect').value; if(!vendor) return alert('SELECT VENDOR');
  const date = el('#billDate').value || '';
  const payer = el('#payerSelect').value || '-';
  const manualSvc = parseFloat(el('#manualService').value) || 0;

  const { lines, grandTotal, sharedPerPerson, manualPerPerson } = computeTotalsDetailed();

  const rowsHtml = lines.map(l=>{
    return `<tr>
      <td style="font-weight:700">${l.name}</td>
      <td>
        Items Total: ${l.itemsTotal}<br/>
        Shared Share: ${l.sharedShare}<br/>
        Manual Share: ${l.manualShare}<br/>
        GST: ${l.gstShare}
      </td>
      <td style="text-align:right;font-weight:700">${l.total}</td>
    </tr>`;
  }).join('');

  openModal('PREVIEW BILL', `
    <div style="display:flex;flex-direction:column;gap:8px">
      <div style="display:flex;justify-content:space-between;gap:8px">
        <div class="tag">DATE: ${date || '-'}</div>
        <div class="tag">VENDOR: ${vendor}</div>
      </div>
      <div style="display:flex;justify-content:space-between;gap:8px">
        <div class="tag">PAYER: ${payer}</div>
        <div class="tag">GST: ${gstEnabled? 'ON':'OFF'}</div>
      </div>
      <div style="display:flex;justify-content:space-between;gap:8px">
        <div class="tag">SHARED TOTAL: ${sharedItems.reduce((s,i)=>s + Number(i.amount||0),0).toFixed(2)}</div>
        <div class="tag">SHARED / PERS: ${sharedPerPerson}</div>
      </div>
      <div style="display:flex;justify-content:space-between;gap:8px">
        <div class="tag">MANUAL TOTAL: ${manualSvc.toFixed(2)}</div>
        <div class="tag">MANUAL / PERS: ${manualPerPerson}</div>
      </div>

      <div class="table-wrap" style="margin-top:6px">
        <table>
          <thead><tr><th>Person</th><th>Breakdown</th><th style="text-align:right">Total</th></tr></thead>
          <tbody>${rowsHtml}</tbody>
          <tfoot><tr><th colspan="2" style="text-align:right">GRAND TOTAL</th><th style="text-align:right">${grandTotal}</th></tr></tfoot>
        </table>
      </div>
    </div>
  `, 'CONFIRM & GENERATE PDF', confirmGenerate);
}

/* ===== confirm generate: persist & PDF ===== */
function confirmGenerate(){
  const billDate = el('#billDate').value || '';
  const vendor = el('#vendorSelect').value || '';
  const payer = el('#payerSelect').value || '';
  const manualSvc = parseFloat(el('#manualService').value) || 0;

  const billData = {
    billID: billCounter,
    date: billDate,
    vendor, payer,
    gst: gstEnabled, manualService: manualSvc,
    persons: JSON.parse(JSON.stringify(persons)),
    sharedItems: JSON.parse(JSON.stringify(sharedItems))
  };

  // compute totals & update owings
  const { lines } = computeTotalsDetailed();
  lines.forEach(l=>{
    if(l.name !== payer){
      const owe = { billID: billCounter, date: billDate, payer, payee: l.name, amount: Number(l.total), status: 'UNPAID' };
      owings.push(owe);
    }
  });

  bills.push(billData); saveLS(LS_BILLS,bills);
  saveLS(LS_OWINGS, owings);

  // Generate PDF
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({unit:'pt', format:'a4'});
  let y = 40;
  doc.setFontSize(18); doc.setFont("helvetica","bold"); doc.text('KUDHIN SPLIT BILL', 40, y); y += 22;
  doc.setFontSize(11); doc.setFont("helvetica","normal");
  doc.text(`BILL ID: ${billCounter}`, 40, y); y += 14;
  doc.text(`DATE: ${billDate}`, 40, y); y += 14;
  doc.text(`VENDOR: ${vendor}`, 40, y); y += 14;
  doc.text(`PAYER: ${payer}`, 40, y); y += 16;
  doc.text(`GST 8%: ${gstEnabled ? 'YES' : 'NO'}`, 40, y); y += 14;
  doc.text(`MANUAL SERVICE TOTAL: ${manualSvc}`, 40, y); y += 18;

  doc.text('SHARED ITEMS:', 40, y); y += 14;
  if(sharedItems.length === 0){ doc.text('- NONE', 60, y); y += 14; }
  else{ sharedItems.forEach(s=>{ doc.text(`- ${s.item}: ${format2(s.amount)}`, 60, y); y += 14; }); }
  y += 8;

  doc.text('PERSONS:', 40, y); y += 14;
  const { lines: finalLines, grandTotal } = computeTotalsDetailed();
  finalLines.forEach(fl=>{
    doc.text(`${fl.name}`, 40, y); y += 12;
    doc.text(`Items: ${fl.itemsTotal}  Shared: ${fl.sharedShare}  Manual: ${fl.manualShare}`, 50, y); y += 12;
    doc.text(`GST: ${fl.gstShare}  => TOTAL: ${fl.total}`, 50, y); y += 18;
    if(y > 720){ doc.addPage(); y = 40; }
  });

  doc.text(`GRAND TOTAL: ${grandTotal}`, 40, y);
  doc.save(`Bill_${billDate.replaceAll('-','') || billCounter}.pdf`);

  billCounter++;
  renderOwings();
  closeModal();
}

/* ===== owings render (card layout) ===== */
function renderOwings(){
  const area = el('#owingsArea'); area.innerHTML = '';
  if(owings.length === 0){
    area.innerHTML = `<div style="padding:18px;border-radius:12px;border:1px dashed #e6f7ff;background:#fbfeff;text-align:center;color:var(--muted)">No owings yet — generate a bill to create owings.</div>`;
    return;
  }
  // group by bill for compact display
  const grouped = {};
  owings.forEach(o=>{
    grouped[o.billID] = grouped[o.billID] || {meta:o, items:[]}; grouped[o.billID].items.push(o);
  });
  Object.keys(grouped).reverse().forEach(bid=>{
    const g = grouped[bid];
    const card = document.createElement('div'); card.className='owing-card';
    const top = document.createElement('div'); top.className='owing-top';
    const left = document.createElement('div'); left.style.flex='1';
    left.innerHTML = `<div style="font-weight:800">Bill #${g.meta.billID}</div><div class="small muted">${g.meta.date || '-'}</div>`;
    const right = document.createElement('div'); right.style.textAlign='right';
    right.innerHTML = `<div style="font-weight:700">${g.meta.payer}</div><div class="small muted">Payer</div>`;
    top.appendChild(left); top.appendChild(right);
    card.appendChild(top);

    // list items
    g.items.forEach(it=>{
      const row = document.createElement('div'); row.style.display='flex';row.style.justifyContent='space-between';row.style.alignItems='center';row.style.marginTop='10px';
      const left = document.createElement('div'); left.innerHTML = `<div style="font-weight:700">${it.payee}</div><div class="small muted">Owes to ${it.payer}</div>`;
      const right = document.createElement('div'); right.style.display='flex'; right.style.flexDirection='column'; right.style.alignItems='flex-end';
      const amt = document.createElement('div'); amt.style.fontWeight='800'; amt.textContent = format2(it.amount);
      const status = document.createElement('div'); status.className = `status ${it.status}`; status.textContent = it.status;
      right.appendChild(amt); right.appendChild(status);
      // actions
      const actions = document.createElement('div'); actions.className='owing-actions';
      const btn = document.createElement('button'); btn.className='btn btn-primary'; btn.textContent = (it.status === 'UNPAID') ? 'Mark Paid' : (it.status === 'PAID' ? 'Confirm Received' : 'Done');
      btn.disabled = (it.status === 'RECEIVED');
      btn.onclick = ()=> {
        if(it.status === 'UNPAID') it.status = 'PAID';
        else if(it.status === 'PAID') it.status = 'RECEIVED';
        saveLS(LS_OWINGS, owings);
        renderOwings();
      };
      actions.appendChild(btn);
      right.appendChild(actions);

      row.appendChild(left); row.appendChild(right);
      card.appendChild(row);
    });

    area.appendChild(card);
  });
}

/* ===== other utilities ===== */
function renderUsers(){ renderUsers = renderUsers; /* placeholder */ }
function renderUsers(){ el('#userListArea').innerHTML = users.map(u=>`<div style="padding:8px;border-radius:8px;border:1px solid #f0f8ff;margin-bottom:6px">${u.name} <span class="small muted">(${u.mobile})</span></div>`).join(''); }

function renderOwingsInitial(){ renderOwings(); }
function exportData(){
  const data = {users,vendors,owings,bills};
  const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'kudhin_export.json'; a.click(); URL.revokeObjectURL(url);
}
function clearAll(){
  if(!confirm('Clear all local storage data (users/vendors/bills/owings)? This cannot be undone.')) return;
  localStorage.removeItem(LS_VENDORS); localStorage.removeItem(LS_BILLS); localStorage.removeItem(LS_OWINGS);
  vendors = []; bills = []; owings = [];
  refreshVendorSelect(); refreshVendorList(); renderOwings();
}

/* ===== init render helpers (overwrite placeholders) ===== */
function renderUsers(){ el('#userListArea').innerHTML = users.map(u=>`<div style="padding:8px;border-radius:8px;border:1px solid #f0f8ff;margin-bottom:6px">${u.name} <span class="small muted">(${u.mobile})</span></div>`).join(''); }
function renderPersonsInit(){ renderPersons(); renderShared(); }
renderPersonsInit();

/* keep vendor list & payer select up to date */
refreshVendorSelect(); refreshVendorList(); updatePayerSelect(); renderUsers(); renderOwings();

/* Accessibility: close modal with ESC */
document.addEventListener('keydown', (e)=> { if(e.key === 'Escape') closeModal(); });

</script>
</body>
</html>
